/*! guestbookMEAN 2014-06-10 */
"use strict";var Promise=require("promise"),collectionName="dedications",factory=require("../models/dedicationFactory"),connector=require("../db/connector"),ObjectID=require("mongodb").ObjectID,getDedicationCollection=function(){return new Promise(function(a,b){connector.connection.createCollection(collectionName,function(c,d){c?b(c):a(d)})})},internalLoadAll=function(a){return console.info("load all dedications"),new Promise(function(b,c){a.find({},{sort:{date:-1}}).toArray(function(a,d){a?c(a):(console.info("loaded all dedications"),b(d))})})},internalFindAuthors=function(a,b){console.info("find authors with prefix %s",b);new RegExp("");return new Promise(function(c,d){a.aggregate([{$match:{author:{$regex:"^"+b,$options:"i"}}},{$group:{_id:"authors",authors:{$addToSet:"$author"}}}],function(a,b){a?d(a):c(b&&b[0]?b[0].authors:[])})})},internalCreate=function(a,b,c){return console.info("create dedication with author: %s and text: %s",b,c),new Promise(function(d,e){a.insert(factory.newInstance(b,c),{safe:!0},function(a,b){a?e(a):(console.info("created dedication with id %s",b[0]._id),d(b[0]))})})},internalRemove=function(a,b){return console.info("remove dedication with id: %s",b),new Promise(function(c,d){a.remove({_id:new ObjectID(b)},{safe:!0},function(a){a?d(a):c(b)})})};exports.loadAll=function(){return getDedicationCollection().then(function(a){return internalLoadAll(a)})},exports.findAuthors=function(a){return getDedicationCollection().then(function(b){return internalFindAuthors(b,a)})},exports.create=function(a,b){return getDedicationCollection().then(function(c){return internalCreate(c,a,b)})},exports.remove=function(a){return getDedicationCollection().then(function(b){return internalRemove(b,a)})};